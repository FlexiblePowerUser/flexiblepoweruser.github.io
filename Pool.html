<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>~ Pool Preview ~</title>
  <style>
    * {
      font-family: 'Ubuntu', Verdana, Tahoma, sans-serif;
    }
    body {
      background-color: #360000;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      text-align: center;
    }
    h1 {
      margin: 0;
    }
    h3 {
      margin-bottom: 20px;
    }
    button {
      background-color: #800000;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }
    #yesBtn {
      background-color: #0051a0;
    }
    #noBtn {
      background-color: #850050;
    }
    button:hover {
      background-color: #b30000;
    }
    img {
      object-fit: contain;
      filter: blur(8px);
      transition: 0.3s;
    }
    #poolButtons {
      margin-top: 15px;
    }
    a {
      color: cyan;
    }
  </style>
</head>
<body>
  <h1>You are leaving the previous area to view an e621 pool.</h1>
  <h3>The post below may contain adult content, so it is blurred. <a href="#" onclick="event.preventDefault(); const img=document.querySelector('#preview img'); if(img) img.style.filter='blur(0)';">(click here to unblur)</a></h3>
  <div id="preview"></div>
  <p id="info">Getting pool info...</p>
  <div>
    <button id="yesBtn">Continue</button>
    <button id="noBtn" onclick="window.close(); window.location.assign('https://google.com')">Nevermind</button>
  </div>
  <p>
    You can use the numbered buttons below to preview posts in this pool.
  </p>
  <div id="poolButtons"></div>
  <script>
    const params = new URLSearchParams(window.location.search);
    const poolId = params.get("id");

    const toWords = s => s.replace(/_/g, " ");

    const previewDiv = document.getElementById("preview");
    const infoP = document.getElementById("info");
    const poolButtonsDiv = document.getElementById("poolButtons");

    async function loadPost(postId) {
      previewDiv.innerHTML = "Loading preview...";
      try {
        const res = await fetch(`https://e621.net/posts/${postId}.json`);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const post = data.post || {};

        previewDiv.innerHTML = "";

        if (post.preview?.url) {
          const img = document.createElement("img");
          img.src = post.preview.url;
          img.alt = "~ Image Preview ~";
          img.style.maxWidth = "512px";
          img.style.maxHeight = "618px";
          img.style.borderRadius = "8px";
          previewDiv.appendChild(img);
        }

        const artists = (post.tags?.artist || []).map(toWords);
        const characters = (post.tags?.character || []).map(toWords);
        const artistText = artists.length ? (artists.length === 1 ? artists[0] : artists.join(", ")) : "unknown artist";
        const charText = characters.length ? characters.join(", ") : `post ${post.id}`;
        infoP.innerHTML = `${charText} created by ${artistText}.`;
      } catch (e) {
        console.error(e);
        previewDiv.innerHTML = "";
        infoP.innerHTML = "Failed to load post preview.";
      }
    }

    (async function () {
      if (!poolId || poolId === "null") {
        infoP.innerHTML = "No pool ID attached.";
        return;
      }

      try {
        const res = await fetch(`https://e621.net/pools/${poolId}.json`);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const pool = await res.json();

        if (!pool.post_ids?.length) {
          infoP.innerHTML = "This pool has no posts.";
          return;
        }

        loadPost(pool.post_ids[0]);

        pool.post_ids.forEach((pid, idx) => {
          const btn = document.createElement("button");
          btn.textContent = (idx + 1).toString();
          btn.addEventListener("click", () => loadPost(pid));
          poolButtonsDiv.appendChild(btn);
        });

        document.getElementById("yesBtn").addEventListener("click", function () {
          window.location.href = "https://e621.net/pools/" + poolId;
        });

      } catch (e) {
        console.error(e);
        infoP.innerHTML = "No pool info found.";
      }
    })();
  </script>
</body>
</html>
